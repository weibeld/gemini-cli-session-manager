# Research: Gemini CLI Session Validation & Behavior

## Overview
Investigation into how the official Gemini CLI handles session files, specifically regarding schema strictness, `projectHash` validation, and data persistence.

## Findings

### 1. Minimal Viable Schema
Gemini CLI accepts session files with a simplified schema. Mandatory fields appear to be:
- `sessionId`
- `projectHash`
- `startTime` (ISO 8601)
- `lastUpdated` (ISO 8601)
- `messages` array with `id`, `timestamp`, `type`, `content`.

Optional fields like `thoughts` and `tokens` can be omitted in manually generated files without causing errors.

### 2. Project Hash Ignorance
**Observation:** When a session file containing a *mismatched* `projectHash` (e.g., from a testbed) is placed into a valid project's `chats/` directory:
1.  `gemini --list-sessions` **successfully lists** the session.
2.  `gemini --resume <id>` **successfully opens** the session.
3.  New messages are appended correctly.

**Conclusion:** Gemini CLI appears to resolve sessions based on **file system location** (scanning the current `chats/` directory) rather than validating the internal `projectHash` field against the current directory's hash at load time.

### 3. Persistence Behavior
When Gemini CLI writes back to a session file (e.g., appending a new response):
- It updates the `lastUpdated` timestamp.
- It appends new messages with full metadata (`thoughts`, `tokens`, `model`).
- It **preserves** existing simplified messages (does not backfill missing metadata).
- **Note:** It does **not** automatically overwrite the `projectHash` field if it was mismatched (based on observation of the "no-change" file).

## Implications for 'geminictl'
- **Resume:** We can confidently use `gemini --resume` on generated/testbed files as long as they are in the correct directory.
- **Move Session:** While we *should* update the `projectHash` when moving a session for consistency, the strictness requirement is lower than expected. The file move itself is the critical operation.

---

## Appendix: Example Data

### Original Testbed File (generated by testbedgen)
```json
{
  "sessionId": "8d987317-e6a4-489a-844a-4dfc799f77e0",
  "projectHash": "039e6b7bf63229bf834a78a1539ea20d0343452543ee7f89de064a2e864cda2f",
  "startTime": "2026-02-05T11:58:56.840Z",
  "lastUpdated": "2026-02-05T11:58:56.840Z",
  "messages": [
    {
      "id": "bc2d5ae2-f675-438d-8639-f13745944ec6",
      "timestamp": "2026-02-05T11:58:56.840Z",
      "type": "user",
      "content": "Hello from the testbed."
    },
    {
      "id": "0ef9500a-1b9e-4569-b0c3-96b0b2eef17d",
      "timestamp": "2026-02-05T11:58:56.840Z",
      "type": "gemini",
      "content": "Acknowledged. This is a minimal compliant session file.",
      "model": "gemini-2.5-flash"
    }
  ]
}
```

### Processed File (after manual hash change and Gemini CLI interaction)
```json
{
  "sessionId": "8d987317-e6a4-489a-844a-4dfc799f77e0",
  "projectHash": "a098ce244f15f7dbee7cbacb22537e848fb06d277ba97e5891be5c9bad0cc789",
  "startTime": "2026-02-05T11:58:56.840Z",
  "lastUpdated": "2026-02-05T12:12:03.034Z",
  "messages": [
    {
      "id": "bc2d5ae2-f675-438d-8639-f13745944ec6",
      "timestamp": "2026-02-05T11:58:56.840Z",
      "type": "user",
      "content": "Hello from the testbed."
    },
    {
      "id": "0ef9500a-1b9e-4569-b0c3-96b0b2eef17d",
      "timestamp": "2026-02-05T11:58:56.840Z",
      "type": "gemini",
      "content": "Acknowledged. This is a minimal compliant session file.",
      "model": "gemini-2.5-flash"
    },
    {
      "id": "641eeb2c-5055-4698-b44c-00251bb9e07a",
      "timestamp": "2026-02-05T12:11:59.414Z",
      "type": "user",
      "content": "What's up?"
    },
    {
      "id": "893d9698-0123-44a4-b1c0-1493700e207c",
      "timestamp": "2026-02-05T12:12:03.034Z",
      "type": "gemini",
      "content": "I am ready to assist with the AWS VPN project. I see a work package for CLI scaffolding in `spec/work-packages/001-cli-scaffolding/`. How can I help you today?",
      "thoughts": [
        {
          "subject": "Responding to the Inquiry",
          "description": "I'm processing the user's \"What's up?\" query. I'm focusing on a professional, command-line-appropriate response, keeping it direct and brief. I also need to integrate a check of the project's current status for context.",
          "timestamp": "2026-02-05T12:12:01.972Z"
        },
        {
          "subject": "Evaluating Project State",
          "description": "I've determined the project is a Terraform project. I've pinpointed the relevant documentation within the `spec/` directory, specifically `001-cli-scaffolding`. My next action is to examine `IMPLEMENTATION.md` to grasp the current status of the CLI scaffolding task. This will inform my response to the user's initial inquiry.",
          "timestamp": "2026-02-05T12:12:02.991Z"
        }
      ],
      "tokens": {
        "input": 7383,
        "output": 45,
        "cached": 3148,
        "thoughts": 187,
        "tool": 0,
        "total": 7615
      },
      "model": "gemini-3-flash-preview"
    }
  ]
}
```
